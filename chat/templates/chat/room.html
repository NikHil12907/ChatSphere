{% load static %}
{% load static tailwind_tags %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ room_name }}</title>
    <script src="https://kit.fontawesome.com/27238bd807.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    {% tailwind_css %}
    <style>
      /* Custom Glow Effect */
      .glow-border {
        border: 1px solid rgba(99, 102, 241, 0.3);
        box-shadow: 0 0 10px rgba(99, 102, 241, 0.3), 0 0 20px rgba(99, 102, 241, 0.2);
      }

      .glow-border:hover {
        border-color: rgba(99, 102, 241, 0.6);
        box-shadow: 0 0 15px rgba(99, 102, 241, 0.5), 0 0 30px rgba(99, 102, 241, 0.4);
      }

      .glow-button {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.9), rgba(79, 70, 229, 0.9));
        border: 1px solid rgba(99, 102, 241, 0.5);
        box-shadow: 0 0 10px rgba(99, 102, 241, 0.3), 0 0 20px rgba(99, 102, 241, 0.2);
      }

      .glow-button:hover {
        background: linear-gradient(135deg, rgba(99, 102, 241, 1), rgba(79, 70, 229, 1));
        box-shadow: 0 0 15px rgba(99, 102, 241, 0.5), 0 0 30px rgba(99, 102, 241, 0.4);
      }

      .chat-message {
        background: rgba(99, 102, 241, 0.1);
        border: 1px solid rgba(99, 102, 241, 0.2);
      }

      .chat-message:hover {
        border-color: rgba(99, 102, 241, 0.5);
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-100 w-full h-screen overflow-hidden">
    <div class="flex h-screen">
      <!-- Sidebar -->
      <aside class="bg-gray-800 w-16 flex flex-col items-center justify-center space-y-8 shadow-lg glow-border">
        <ul class="space-y-6">
          <li class="p-4 hover:bg-gray-700 text-2xl rounded-lg transition flex justify-center items-center cursor-pointer glow-border" onclick="showPopup('profile')">
            <i class="fa-regular fa-user text-indigo-400"></i>
          </li>
          <li class="p-4 hover:bg-gray-700 text-2xl rounded-lg transition flex justify-center items-center cursor-pointer glow-border" onclick="showPopup('rooms')">
            <i class="fa-brands fa-rocketchat text-indigo-400"></i>
          </li>
          <li class="p-4 hover:bg-gray-700 text-2xl rounded-lg transition flex justify-center items-center cursor-pointer glow-border" onclick="showPopup('settings')">
            <i class="fa-solid fa-gear text-indigo-400"></i>
          </li>
        </ul>
      </aside>

      <!-- Main Chat Section -->
      <main class="flex-1 flex flex-col">
        <header class="p-4 bg-gray-800 shadow-lg glow-border">
          <h2 class="text-lg font-medium text-indigo-400" id="chat-title">{{ room_name }}</h2>
        </header>

        <!-- Chat Log -->
        <div id="chat-log" class="flex-1 overflow-y-auto p-4 bg-gray-700">
          {% for message in messages %}
            <div class="my-2 {% if message.user.username == username %}ml-auto text-right{% else %}mr-auto text-left{% endif %}">
              <div class="text-sm font-semibold text-gray-300 mb-1">{{ message.user.username }}</div>
              <div class="p-3 bg-indigo-600 text-white max-w-xs inline-block rounded-lg shadow-lg break-words chat-message">{{ message.content }}</div>
              <div class="text-xs text-gray-400 mt-1">{{ message.timeStamp }}</div>
            </div>
          {% endfor %}
        </div>

        <!-- Chat Input -->
        <footer class="p-4 bg-gray-800 shadow-lg glow-border">
          <div class="flex items-center space-x-2">
            <input
              type="text"
              id="chat-message-input"
              class="flex-1 bg-gray-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
              placeholder="Type your message..."
            />
            <input type="file" id="file-input" class="hidden" multiple>
            <label for="file-input" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg cursor-pointer glow-border">
              <i class="fa-solid fa-paperclip text-gray-300"></i>
            </label>
            <button
              id="chat-message-submit"
              class="glow-button text-white px-4 py-2 rounded-lg shadow-md focus:outline-none transition"
            >
              Send
            </button>
          </div>
        </footer>
      </main>
    </div>

    <!-- Popup Modals -->
    <!-- Profile Popup -->
    <div id="profile-popup" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center p-4">
      <div class="bg-gray-800 p-6 rounded-lg w-full max-w-2xl transform transition-all duration-300 ease-in-out glow-border">
        <h1 class="text-xl font-semibold mb-4 text-indigo-400">Profile</h1>
        <div class="flex justify-center">
          <img src="{{ user.profile.profile_picture.url|default:'static/images/default-avatar.png' }}" alt="Profile Picture" class="w-24 h-24 rounded-full border-2 border-indigo-400">
        </div>
        <div class="text-center mt-4">
          <h1 class="text-lg font-medium text-gray-100">{{ user.username }}</h1>
          <p class="text-sm text-gray-300">{{ user.profile.bio|default:"No Bio Available" }}</p>
        </div>
        <div class="text-center mt-2">
          <p class="text-sm text-gray-300">{{ user.profile.dob|date:"F j, Y"|default:"Not Provided" }}</p>
        </div>
        <button onclick="hidePopup('profile-popup')" class="mt-4 w-full p-2 glow-button rounded-lg">Close</button>
      </div>
    </div>

    <!-- Rooms Popup -->
    <div id="rooms-popup" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center p-4">
      <div class="bg-gray-800 p-6 rounded-lg w-full max-w-2xl transform transition-all duration-300 ease-in-out glow-border">
        <h1 class="text-xl font-semibold mb-4 text-indigo-400">Rooms</h1>
        <ul>
          {% for room in rooms %}
            <li class="p-2 hover:bg-gray-700 rounded-lg cursor-pointer glow-border">
              <a href={% url "room" room.name %} class="block">{{ room.name }}</a>
            </li>
          {% endfor %}
        </ul>
        <button onclick="hidePopup('rooms-popup')" class="mt-4 w-full p-2 glow-button rounded-lg">Close</button>
      </div>
    </div>

    <!-- Settings Popup -->
    <div id="settings-popup" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center p-4">
      <div class="bg-gray-800 p-6 rounded-lg w-full max-w-2xl transform transition-all duration-300 ease-in-out glow-border">
        <h1 class="text-xl font-semibold mb-4 text-indigo-400">Settings</h1>
        <div class="space-y-4">
          <!-- Theme Selection -->
          <div>
            <h2 class="text-lg font-medium text-gray-100">Theme</h2>
            <select class="w-full p-2 bg-gray-700 text-gray-100 rounded-lg focus:outline-none">
              <option value="dark">Dark</option>
              <option value="light">Light</option>
              <option value="system">System Default</option>
            </select>
          </div>

          <!-- Notification Preferences -->
          <div>
            <h2 class="text-lg font-medium text-gray-100">Notifications</h2>
            <div class="flex items-center space-x-4">
              <label class="flex items-center">
                <input type="checkbox" class="form-checkbox h-5 w-5 text-indigo-400">
                <span class="ml-2 text-gray-300">Enable Notifications</span>
              </label>
            </div>
          </div>

          <!-- Logout Button -->
          <div>
            <button onclick="showPopup('log-out')" class="w-full p-2 bg-red-600 hover:bg-red-500 text-white rounded-lg">Log Out</button>
          </div>
        </div>
        <button onclick="hidePopup('settings-popup')" class="mt-4 w-full p-2 glow-button rounded-lg">Close</button>
      </div>
    </div>

    <!-- Log-out Popup -->
    <div id="log-out-popup" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center p-4">
      <div class="bg-gray-800 p-6 rounded-lg w-full max-w-md transform transition-all duration-300 ease-in-out glow-border">
        <h1 class="text-xl font-semibold mb-4 text-indigo-400">Log-out</h1>
        <p class="mb-4 text-gray-300">Are you sure you want to log out?</p>
        <button class="w-full p-2 bg-red-600 hover:bg-red-500 text-white rounded-lg">Log Out</button>
        <button onclick="hidePopup('log-out-popup')" class="mt-2 w-full p-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg">Cancel</button>
      </div>
    </div>

    {{ room_name|json_script:"room-name" }}
    <script>
      function showPopup(popupId) {
        const popup = document.getElementById(`${popupId}-popup`);
        popup.classList.remove("hidden");
        setTimeout(() => popup.classList.add("opacity-100"), 10);
      }

      function hidePopup(popupId) {
        const popup = document.getElementById(popupId);
        popup.classList.remove("opacity-100");
        setTimeout(() => popup.classList.add("hidden"), 300);
      }

      // Close popup when clicking outside the modal
      window.onclick = function (event) {
        const modals = ["profile-popup", "rooms-popup", "settings-popup", "log-out-popup"];
        modals.forEach((modalId) => {
          const modal = document.getElementById(modalId);
          if (event.target === modal) {
            hidePopup(modalId);
          }
        });
      };

      // WebSocket and chat functionality
      const roomName = JSON.parse(document.getElementById("room-name").textContent);
      const chatSocket = new WebSocket("ws://" + window.location.host + "/ws/chat/" + roomName + "/");

      chatSocket.onmessage = function (event) {
        const data = JSON.parse(event.data);
        const currentUsername = "{{ username }}";
        const chatLog = document.querySelector("#chat-log");

        if (data.message) {
          const msgContainer = document.createElement("div");
          const usernameDiv = document.createElement("div");
          const messageDiv = document.createElement("div");
          const timeStampDiv = document.createElement("div");

          usernameDiv.textContent = data.username;
          usernameDiv.classList.add("text-sm", "font-semibold", "text-gray-300", "mb-1");
          messageDiv.textContent = data.message;
          messageDiv.classList.add("p-3", "bg-indigo-600", "text-white", "max-w-xs", "inline-block", "rounded-lg", "shadow-lg", "break-words");
          timeStampDiv.textContent = data.timeStamp;
          timeStampDiv.classList.add("text-xs", "text-gray-400", "mt-1");

          if (data.username === currentUsername) {
            msgContainer.classList.add("ml-auto", "text-right");
          } else {
            msgContainer.classList.add("mr-auto", "text-left");
          }

          msgContainer.appendChild(usernameDiv);
          msgContainer.appendChild(messageDiv);
          msgContainer.appendChild(timeStampDiv);
          chatLog.appendChild(msgContainer);
        } else if (data.file) {
          const filelink = document.createElement('a');
          filelink.href = data.file;
          filelink.download = data.filename;
          filelink.textContent = `Download ${data.filename}`;
          filelink.classList.add("text-indigo-400", "hover:text-indigo-300");

          const fileDiv = document.createElement('div');
          fileDiv.classList.add("my-2");
          fileDiv.appendChild(filelink);
          chatLog.appendChild(fileDiv);
        }
        chatLog.scrollTop = chatLog.scrollHeight;
      };

      chatSocket.onclose = function (e) {
        console.error("Chat Socket Closed unexpectedly");
      };

      document.querySelector("#chat-message-input").focus();
      document.querySelector("#chat-message-input").onkeyup = function (e) {
        if (e.keyCode === 13) {
          document.querySelector("#chat-message-submit").click();
        }
      };

      document.querySelector("#chat-message-submit").onclick = function (e) {
        let messageInputDom = document.querySelector("#chat-message-input");
        let msg = messageInputDom.value;
        if (msg.trim() != "") {
          chatSocket.send(
            JSON.stringify({
              message: msg,
            })
          );
          messageInputDom.value = "";
        }
      };
    </script>
  </body>
</html>